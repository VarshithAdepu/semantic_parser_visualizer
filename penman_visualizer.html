<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Semantic Graph Visualizer</title>

<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/svg-crowbar@0.7.4/dist/svg-crowbar.min.js"></script>

<style>
/* -------- LIGHT PASTEL THEME -------- */
:root {
  --bg-main: #f5f9ff;
  --card-bg: #ffffff;
  --border: #d6e2f0;
  --accent: #7fb7be;
  --root-node: #e6ddff;
  --highlight: #ff7675;
  --text-main: #2f3a45;
  --shadow: rgba(0,0,0,0.08);
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: var(--bg-main);
  color: var(--text-main);
  height: 100vh;
  overflow: hidden; 
}

.header {
  padding: 16px 24px;
  background: #eef4ff;
  border-bottom: 1px solid var(--border);
  font-size: 20px;
  font-weight: 600;
  height: 70px;
}

.container {
  display: grid;
  grid-template-columns: 1fr 1.6fr;
  gap: 16px;
  padding: 16px;
  height: calc(100vh - 70px);
  overflow: hidden; 
}

.card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 6px 14px var(--shadow);
  padding: 14px;
  display: flex;
  flex-direction: column;
  overflow: hidden; 
  height: 100%;
}

.card h3 {
  margin: 0 0 10px 0;
  font-size: 16px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 6px;
  flex-shrink: 0;
}

textarea {
  flex: 1;
  resize: none;
  font-family: 'Courier New', monospace;
  font-size: 14px;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #fdfefe;
  min-height: 0; 
}

.controls {
  margin-top: 12px;
  flex-shrink: 0;
}

button {
  padding: 8px 16px;
  margin-right: 8px;
  border-radius: 8px;
  border: 1px solid var(--accent);
  background: #eaf6f8;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}

button:hover {
  background: var(--accent);
  color: white;
}

#graph {
  flex: 1;
  min-height: 0;
  width: 100%;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: #ffffff;
}

.hint {
  font-size: 12px;
  color: #6b7c8f;
  margin-top: 8px;
  flex-shrink: 0;
}
</style>
</head>
<body>

<div class="header">
  Semantic Graph Visualizer
</div>

<div class="container">
  <div class="card">
    <h3>Input Structure</h3>
<textarea id="input">
<segment_id=ALT_002>
#या तो आप चाय बनाओ, या आप पानी गरम कर दो।
आप            1        3:k1
चाय           2        3:k2
बनाओ_1        3        4:op1
या             4        0:main
आप            5        7:k1
पानी           6        7:k2
गरम_कर_दो_1   7        4:op2
</segment_id>
</textarea>

    <div class="controls">
      <button onclick="renderGraph()">Render</button>
      <button onclick="toggleLayout()">Elastic ↔ Stiff</button>
      <button onclick="exportSVG()">Export SVG</button>
    </div>

    <div class="hint">
      <b>Click a node</b> to highlight path. <br>
      <b>0:main</b> is required for the root.
    </div>
  </div>

  <div class="card">
    <h3>Semantic Graph</h3>
    <div id="graph"></div>
    <div class="hint">
      Root highlighted in lavender • Path trace in red
    </div>
  </div>
</div>

<script>
let network = null;
let elastic = false;
let currentNodes = null;
let currentEdges = null;

/* -------- ROBUST PARSER -------- */
function parseInput(text) {
  const nodes = [];
  const edges = [];
  let rootId = null;

  const lines = text.split(/\r?\n/);

  lines.forEach(line => {
    line = line.trim();
    if (!line || line.startsWith("<") || line.startsWith("#")) return;

    const tokens = line.split(/[\s\u00A0]+/).filter(t => t.length > 0);
    
    if (tokens.length < 3) return;

    const concept = tokens[0];
    const id = tokens.find(t => /^\d+$/.test(t));
    const relToken = tokens.find(t => t.includes(":"));

    if (!id || !relToken) return;

    const [head, rel] = relToken.split(":");

    nodes.push({
      id: id,
      label: concept,
      shape: "box",
      margin: 10,
      // FONT SIZE INCREASED HERE (Node)
      font: { size: 22, color: "#2f3a45" },
      color: { background: "#ffffff", border: "#7fb7be" }
    });

    if (head === "0" && rel === "main") {
      rootId = id;
    } else {
      edges.push({
        id: `e${head}-${id}`,
        from: head,
        to: id,
        label: rel,
        arrows: "to",
        color: { color: "#adc2d1" },
        // FONT SIZE INCREASED HERE (Edge Label)
        font: { size: 16, align: "middle", bold: { mod: "bold" } }
      });
    }
  });

  return { nodes, edges, rootId };
}

/* -------- HIGHLIGHT PATH -------- */
function highlightPath(nodeId) {
  const allNodes = currentNodes.get();
  const allEdges = currentEdges.get();
  
  allNodes.forEach(n => {
    n.color = { background: n.isRoot ? "#e6ddff" : "#ffffff", border: "#7fb7be" };
    n.widthConstraint = false;
  });
  allEdges.forEach(e => {
    e.color = { color: "#adc2d1" };
    e.width = 1;
  });

  let currId = nodeId;
  while (currId) {
    const parentEdge = allEdges.find(e => e.to === currId);
    
    const node = allNodes.find(n => n.id === currId);
    if (node) {
      node.color = { background: node.isRoot ? "#e6ddff" : "#fff0f0", border: "#ff7675" };
    }

    if (parentEdge) {
      parentEdge.color = { color: "#ff7675" };
      parentEdge.width = 3;
      currId = parentEdge.from;
    } else {
      currId = null;
    }
  }

  currentNodes.update(allNodes);
  currentEdges.update(allEdges);
}

/* -------- RENDER GRAPH -------- */
function renderGraph() {
  const text = document.getElementById("input").value;
  const { nodes, edges, rootId } = parseInput(text);

  if (!rootId) {
    alert("Root not found. Please ensure one line contains '0:main'");
    return;
  }

  nodes.forEach(n => {
    if (n.id === rootId) {
      n.isRoot = true;
      n.color = { background: "#e6ddff", border: "#9b85d9" };
    }
  });

  currentNodes = new vis.DataSet(nodes);
  currentEdges = new vis.DataSet(edges);

  const data = { nodes: currentNodes, edges: currentEdges };

  const options = {
    // LAYOUT SETTINGS MODIFIED FOR COMPACTNESS
    physics: {
      enabled: elastic,
      barnesHut: {
        springLength: 70, // Short edges in Elastic mode
        springConstant: 0.05
      }
    },
    layout: {
      hierarchical: elastic ? false : {
        enabled: true,
        direction: "UD",
        nodeSpacing: 160,     // Compact horizontal spacing
        levelSeparation: 90,  // Reduced vertical edge length
        sortMethod: "directed"
      }
    },
    interaction: { hover: true }
  };

  if (network) network.destroy();
  network = new vis.Network(document.getElementById("graph"), data, options);

  network.on("click", function(params) {
    if (params.nodes.length > 0) {
      highlightPath(params.nodes[0]);
    }
  });
}

function toggleLayout() {
  elastic = !elastic;
  renderGraph();
}

function exportSVG() {
  const svg = document.querySelector("#graph svg");
  if (!svg) {
    alert("Please render the graph first.");
    return;
  }
  svgCrowbar.download(svg, "semantic_graph.svg");
}

renderGraph();
</script>

</body>
</html>